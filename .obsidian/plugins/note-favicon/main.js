/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var p=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var C=(n,i)=>{for(var e in i)p(n,e,{get:i[e],enumerable:!0})},y=(n,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let a of w(i))!T.call(n,a)&&a!==e&&p(n,a,{get:()=>i[a],enumerable:!(t=F(i,a))||t.enumerable});return n};var I=n=>y(p({},"__esModule",{value:!0}),n);var S={};C(S,{default:()=>E});module.exports=I(S);var m=require("obsidian");var g=require("obsidian"),u={enabled:!0},o=class extends g.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new g.Setting(e).setName("Reset cache").setDesc("Clear favicons local cache").addButton(t=>t.setButtonText("Reset").onClick(async()=>{this.plugin.clearCache()}))}};var A=require("obsidian");var c=class{static uint8ArrayToDataURL(i,e="image/png"){let t=i.reduce((s,r)=>s+String.fromCharCode(r),""),a=btoa(t);return`data:${e};base64,${a}`}};var f=class{constructor(i,e){this.image=i,this.timestamp=e}},l=class{constructor(i,e,t){this.cacheFileName="cache.json";this.defaultIcon="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAAGHaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj48dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4slJgLAAADS0lEQVRYR+2XPUjrfBjFT94ItSIVC4KDVBwVxNHFQUHoGm1FCoooKAiCg1QnEcHBQXDpVKi4+AGKoIiLCn6gVBGV+k0FCwYjikrRJkjSPO9ylZv/TXpzffW+d7i/qZxzEg7P04T8OSIi/I9wVgUuLi5wf3/Pyj+F53lUVFQgJyeHtUwxLTAxMYFIJAKXy4V0Os3alvA8j7u7O7y+vmJ8fBzl5eVs5EfIBEEQaGVlhZVtMT8/Tx6PhyorK+n4+Ji1f+AfthAAOBwO5Ofns7Itnp+f4ff7EQwG0dDQgFgsxkYMmBYAAFVVWckWuq4jkUjA5/NhYGAALS0tODo6YmPvWBb4KDU1NXh4eIAgCFhdXYUoimhubkYqlWKjwFcUKCoqwszMDDo7O+Hz+TA1NQWO43B1dcVGga8oAAAFBQXwer3wer2ora2F2+2GrutsDPiqAt8jyzJ0XQfHcawF/I4CP+NvAVsFLi8vEY1GAQBnZ2fY2dkx+Dc3N1hfXwcAXF9fY3Nz0+BnwlaBl5cX9Pb2IhwOo6OjA/F43OBrmob+/n6Mjo6ira0N+/v7Bj8j7LuZiKixsZGi0ahBm56eJgDU3d1t0N9YW1sjAFRXV2fQU6kUVVdXUywWM+hv2JrA+fk5QqEQgsEgDg4OsLi4aPBFUcTg4CC6urrw+PiISCRi8DORxQpmqKqKnp4eCIKAra0tyLJs8NPpNNrb2xEIBBCLxZBIJAx+RtiRkMUKPsqnrIAlmUxib28PS0tL2NjYgCiKbMQ2tlbwxsnJCUKhEA4PD5Gbmwu32w1FUXB7e4vi4mIEAgHU19ezl2WGHQmZrEBVVRoZGaGysjLq6+uj09NTUhSFiIg0TSNJkmhsbIyqqqqoqamJJEl6v/ZTVrC9vY2FhQVMTk5ieHgYpaWlyM7OBr59BxYWFqK1tRXLy8vgeR7hcJi9hTVsIzKZgCzLpKqqIZOJZDL5/vtTJuB0OpGVZf/v4nK5WMkSWwW+kj+3gNUXzK/CcVzGe5kW0DTtl3aeCafTCUVRYHIAA6yOZkNDQ9jd3UVJScmHzwf49og+PT1BkiTMzc0hLy+PjZgX0HUds7OziMfj/2kSuq7D4XDA7/fD4/GwNmBV4HfyL2+NS0q9hHyrAAAAAElFTkSuQmCC";this.localCache=null;this.app=i,this.manifest=e,this.settings=t}async loadCache(){if(this.localCache)return this.localCache;try{let i=await this.app.vault.adapter.read(this.getCacheFilePath());return this.localCache=i?JSON.parse(i):{},this.localCache}catch(i){return{}}}async updateCache(i,e){this.localCache=null;let t=await this.loadCache(),a=this.getHostname(i);return a?(t[a]=new f(e,Date.now()),await this.app.vault.adapter.write(this.getCacheFilePath(),JSON.stringify(t)),e):""}async getCachedFavicon(i){let e=await this.loadCache(),t=this.getHostname(i);return t&&e[t]?e[t].image:""}async fetchAndCacheFavicon(i){let e=this.getHostname(i),t="";if(e){let a=`https://www.google.com/s2/favicons?sz=32&domain=${e}`;try{let s=await(0,A.requestUrl)({url:a,method:"GET"});t=c.uint8ArrayToDataURL(new Uint8Array(s.arrayBuffer))}catch(s){console.error("Favicon fetch error:",s)}}return this.updateCache(i,t)}getHostname(i){try{return new URL(i).origin}catch(e){return null}}async clearCache(){this.localCache=null;try{await this.app.vault.adapter.remove(this.getCacheFilePath())}catch(i){}await this.loadCache()}getCacheFilePath(){return this.app.vault.configDir+"/plugins/"+this.manifest.id+"/"+this.cacheFileName}};var v="base64",N="url",h=class extends m.Plugin{constructor(){super(...arguments);this.settings=u;this.cache=null}async onload(){await this.loadSettings(),console.log("Loading NoteFaviconPlugin..."),this.cache=new l(this.app,this.manifest,this.settings),this.registerEvent(this.app.vault.on("modify",e=>{this.settings.enabled&&e instanceof m.TFile&&this.updateImageForNoteInTree(e)})),this.registerEvent(this.app.metadataCache.on("changed",e=>{this.settings.enabled&&this.updateImageForNoteInTree(e)})),this.app.workspace.onLayoutReady(async()=>{this.settings.enabled&&(await sleep(500),await this.updateTree())}),this.addSettingTab(new o(this.app,this))}onunload(){console.log("Unloading NoteFaviconPlugin..."),this.removeAllFavicons()}async loadSettings(){this.settings=Object.assign({},u,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.settings.enabled?await this.updateTree():this.removeAllFavicons()}async updateTree(){if(!this.settings.enabled)return;let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateImageForNoteInTree(t)}async updateImageForNoteInTree(e){if(!this.settings.enabled||!e||!e.path.endsWith(".md")||!this.cache||"saving"in e&&e.saving)return;let t=await this.getMetadata(e);if(!t||!t.favicon){this.removeImageFromTreeElement(e.path);return}let a;if(this.getIconType(t.favicon)===v?a=t.favicon:(a=await this.cache.getCachedFavicon(t.favicon),a||(a=await this.cache.fetchAndCacheFavicon(t.favicon))),!a){this.removeImageFromTreeElement(e.path);return}let r=this.findTreeElementForFile(e.path);r&&this.updateImageInTreeElement(r,a)}removeAllFavicons(){let e=this.app.vault.getMarkdownFiles();for(let t of e)this.removeImageFromTreeElement(t.path)}async getMetadata(e){let t=this.app.metadataCache.getFileCache(e);return(t==null?void 0:t.frontmatter)||null}findTreeElementForFile(e){var s;let t=this.app.workspace.getLeavesOfType("file-explorer")[0];if(!t)return null;let a=t.view;if(!a||!a.fileItems)return null;for(let r of Object.values(a.fileItems)){let d=r;if(((s=d.file)==null?void 0:s.path)===e)return d.selfEl}return null}removeImageFromTreeElement(e){let t=this.findTreeElementForFile(e);if(t){let a=t.querySelector(".tree-favicon");a&&t.removeChild(a)}}updateImageInTreeElement(e,t){if(!t)return;let a=e.querySelector(".tree-favicon");a?a.src=t:(a=document.createElement("img"),a.classList.add("tree-favicon"),a.src=t,e.insertBefore(a,e.firstChild))}clearCache(){this.cache&&this.cache.clearCache().then(()=>{this.updateTree()})}getIconType(e){return e&&e.trim().toLowerCase().startsWith("data:image")?v:N}};var E=h;
/*
 * Obsidian Note Favicon Plugin
 *
 * @description This plugin for Obsidian extracts a URL from the note's frontmatter and displays an associated image (favicon) next to the note title in the file tree.
 * @author mdklab
 * @license MIT
 */

/* nosourcemap */